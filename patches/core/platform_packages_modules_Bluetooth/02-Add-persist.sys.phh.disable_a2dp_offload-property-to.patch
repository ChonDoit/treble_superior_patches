From 372796a9b26af8396c42591adc9c735c06892b5c Mon Sep 17 00:00:00 2001
From: Pierre-Hugues Husson <phh@phh.me>
Date: Mon, 25 May 2020 21:25:12 +0200
Subject: [PATCH] Add persist.sys.phh.disable_a2dp_offload property to force
 a2dp offload

---
 system/btif/src/btif_av.cc             | 7 ++++++-
 system/stack/a2dp/a2dp_codec_config.cc | 9 +++++++--
 2 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/system/btif/src/btif_av.cc b/system/btif/src/btif_av.cc
index 8ae8db8add..5e0bccb134 100644
--- a/system/btif/src/btif_av.cc
+++ b/system/btif/src/btif_av.cc
@@ -981,9 +981,14 @@ bt_status_t BtifAvSource::Init(
   osi_property_get("ro.bluetooth.a2dp_offload.supported", value_sup, "false");
   osi_property_get("persist.bluetooth.a2dp_offload.disabled", value_dis,
                    "false");
+  char value_phh[PROPERTY_VALUE_MAX] = {'\0'};
+  osi_property_get("persist.sys.phh.disable_a2dp_offload", value_phh, "false");
   a2dp_offload_enabled_ =
       (strcmp(value_sup, "true") == 0) && (strcmp(value_dis, "false") == 0);
-  BTIF_TRACE_DEBUG("a2dp_offload.enable = %d", a2dp_offload_enabled_);
+  if(strcmp(value_phh, "true") == 0)
+      a2dp_offload_enabled_ = false;
+
+  LOG_ERROR("a2dp_offload.enable = %s", a2dp_offload_enabled_ ? "on" : "off");
 
   callbacks_ = callbacks;
   if (a2dp_offload_enabled_) {
diff --git a/system/stack/a2dp/a2dp_codec_config.cc b/system/stack/a2dp/a2dp_codec_config.cc
index 52e0f6fcb1..d3ac2b9365 100644
--- a/system/stack/a2dp/a2dp_codec_config.cc
+++ b/system/stack/a2dp/a2dp_codec_config.cc
@@ -557,13 +557,18 @@ bool A2dpCodecs::init() {
   char* tok = NULL;
   char* tmp_token = NULL;
   bool offload_codec_support[BTAV_A2DP_CODEC_INDEX_MAX] = {false};
-  char value_sup[PROPERTY_VALUE_MAX], value_dis[PROPERTY_VALUE_MAX];
+  char value_sup[PROPERTY_VALUE_MAX], value_dis[PROPERTY_VALUE_MAX], value_phh[PROPERTY_VALUE_MAX];
 
   osi_property_get("ro.bluetooth.a2dp_offload.supported", value_sup, "false");
   osi_property_get("persist.bluetooth.a2dp_offload.disabled", value_dis,
                    "false");
+  osi_property_get("persist.sys.phh.disable_a2dp_offload", value_phh, "false");
   a2dp_offload_status =
       (strcmp(value_sup, "true") == 0) && (strcmp(value_dis, "false") == 0);
+  if(strcmp(value_phh, "true") == 0)
+      a2dp_offload_status = false;
+
+  LOG_ERROR("Got a2dp offload status %s", a2dp_offload_status ? "on" : "off");
 
   if (a2dp_offload_status) {
     char value_cap[PROPERTY_VALUE_MAX];
@@ -652,7 +657,7 @@ bool A2dpCodecs::init() {
     }
   }
 
-  return (!ordered_source_codecs_.empty() && !ordered_sink_codecs_.empty());
+  return (!ordered_source_codecs_.empty() && !ordered_sink_codecs_.empty()) && !a2dp_offload_status;
 }
 
 A2dpCodecConfig* A2dpCodecs::findSourceCodecConfig(
