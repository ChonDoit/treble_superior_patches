From 3d0e96fd724c2edea5039216e931d20cf358dbd4 Mon Sep 17 00:00:00 2001
From: ChonDoit <thphantomblog@gmail.com>
Date: Wed, 28 Sep 2022 23:55:21 -0300
Subject: [PATCH] Restore support for audio HAL V2 from the framework

---
 media/libaudiohal/Android.bp         |  1 +
 media/libaudiohal/FactoryHalHidl.cpp |  3 ++-
 media/libaudiohal/impl/Android.bp    | 19 +++++++++++++++++++
 3 files changed, 22 insertions(+), 1 deletion(-)

diff --git a/media/libaudiohal/Android.bp b/media/libaudiohal/Android.bp
index 5f63e8de04..cd166676e3 100644
--- a/media/libaudiohal/Android.bp
+++ b/media/libaudiohal/Android.bp
@@ -23,6 +23,7 @@ cc_library_shared {
     ],
 
     required: [
+	"libaudiohal@2.0",
         "libaudiohal@4.0",
         "libaudiohal@5.0",
         "libaudiohal@6.0",
diff --git a/media/libaudiohal/FactoryHalHidl.cpp b/media/libaudiohal/FactoryHalHidl.cpp
index 590fec5443..35bd7c817c 100644
--- a/media/libaudiohal/FactoryHalHidl.cpp
+++ b/media/libaudiohal/FactoryHalHidl.cpp
@@ -41,7 +41,8 @@ static constexpr std::array<std::pair<std::pair<int, int>, const char*>, 5> sAud
     DECLARE_VERSION(7, 0),
     DECLARE_VERSION(6, 0),
     DECLARE_VERSION(5, 0),
-    DECLARE_VERSION(4, 0)
+    DECLARE_VERSION(4, 0),
+    DECLARE_VERSION(2, 0),
 };
 
 bool createHalService(const std::string& version, const std::string& interface,
diff --git a/media/libaudiohal/impl/Android.bp b/media/libaudiohal/impl/Android.bp
index d30883a95c..6815d9500d 100644
--- a/media/libaudiohal/impl/Android.bp
+++ b/media/libaudiohal/impl/Android.bp
@@ -68,6 +68,25 @@ cc_defaults {
     ],
 }
 
+cc_library_shared {
+    name: "libaudiohal@2.0",
+    defaults: ["libaudiohal_default"],
+    shared_libs: [
+        "android.hardware.audio.common@2.0",
+        "android.hardware.audio.common@2.0-util",
+        "android.hardware.audio.effect@2.0",
+        "android.hardware.audio.effect@2.0-util",
+        "android.hardware.audio@2.0",
+        "android.hardware.audio@2.0-util",
+    ],
+    cflags: [
+        "-DMAJOR_VERSION=2",
+        "-DMINOR_VERSION=0",
+        "-include common/all-versions/VersionMacro.h",
+    ]
+}
+
+
 cc_library_shared {
     name: "libaudiohal@4.0",
     defaults: ["libaudiohal_default"],
-- 
2.37.3

